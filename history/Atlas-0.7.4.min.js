/**
 * Atlas.js v0.7.4
 * https://github.com/steelydylan/Atlas.js
 * Copyright steelydylan
 * <http://steelydylan.webcrow.jp/>
 * Released under the MIT license.
 */
!function(){"use strict";var t=[],i=[],e=[],h=0,s=function(){var t=navigator.userAgent;return t.indexOf("iPhone")>0&&-1==t.indexOf("iPad")||t.indexOf("iPod")>0||t.indexOf("Android")>0?!0:!1}(),n=function(){var t=window.matchMedia("(orientation: portrait)");return t.matches?"portrait":"landscape"}(),r=function(t,i,e){var h=e.which;switch(h){case 13:t.enter=!0,i.enter=!0;break;case 16:t.shift=!0,i.shift=!0;break;case 32:t.space=!0,i.space=!0;break;case 39:t.right=!0,i.right=!0;break;case 37:t.left=!0,i.left=!0;break;case 38:t.up=!0,i.up=!0;break;case 40:t.down=!0,i.down=!0;break;case 8:t.backspace=!0,i.backspace=!0}for(var s=0;26>s;s++)if(s+65==h){var n=String.fromCharCode(s+97);t[n]=!0,i[n]=!0;break}},a=function(t){t.enter=!1,t.shift=!1,t.space=!1,t.right=!1,t.left=!1,t.up=!1,t.down=!1,t.backspace=!1;for(var i=0;26>i;i++)t[String.fromCharCode(i+97)]=!1},o=function(){var t=new Object;return a(t),t}(),c=function(){for(var t in c)window[t]=c[t]};c.createClass=function(t,i){var e=function(){this.initialize.apply(this,arguments)};"function"==typeof t&&"object"==typeof i?(e.prototype=Object.create(t.prototype),e.prototype.inherit=function(){this.initialize=this.superClass.prototype.initialize,this.superClass=this.superClass.prototype.superClass,this.initialize&&this.initialize.apply(this,arguments)}):"object"==typeof t&&null==i&&(i=t);for(var h in i)e.prototype[h]=i[h];return e.prototype.superClass=t,e},c.extendClass=function(t,i){for(var e in i)t.prototype[e]=i[e]};var l=function(t,i,e){var h=t.mover,s=h[h.length-1];if(s&&s.and)var n=s;else{var n=new Object;h.push(n)}return n.time=0,e&&(n.frame=e),n.loop=!1,n.and=!1,n[i]=!0,n};c.Util=c.createClass({isMobile:s,orientation:n,initialize:function(){this.eventListener=new Object,this.mover=[],this.rot=0,this.moverIndex=0,this.visible=!0,this.eventEnable=!0,this.drawMode="source-over";var t=this.eventListener;t.touchStart=!1,t.touchMove=!1,t.touchEnd=!1,t.keyUp=!1,t.keyDown=!1,t.multiTouchStart=!1,t.multiTouchMove=!1,t.multiTouchEnd=!1,t.orientationChange=!1},tween:function(){var t=this.mover,i=t.length;if(this.moverIndex<i){var e=t[this.moverIndex];e.animate&&this._animate(e),e.moveTo&&this._moveTo(e),e.moveBy&&this._moveBy(e),e.rotateBy&&this._rotateBy(e),e.scaleBy&&this._scaleBy(e),e.then&&this._then(e),e.time++,e.time>e.frame&&(this.moverIndex++,this.moverIndex==i&&(e.loop?this._refresh():this.stop()))}},isQueEmpty:function(){return this.mover.length?!1:!0},_refresh:function(){this.moverIndex=0;for(var t=this.mover,i=0,e=t.length;e>i;i++){var h=t[i];h.time&&(h.time=0)}},moveTo:function(t,i,e){var h=l(this,"moveTo",e);return h.toX=t,h.toY=i,this},_moveTo:function(t){0==t.time&&(t.diffX=t.toX-this.x,t.diffY=t.toY-this.y),this.x=t.toX-t.diffX*(1-t.time/t.frame),this.y=t.toY-t.diffY*(1-t.time/t.frame)},moveBy:function(t,i,e){var h=l(this,"moveBy",e);return h.diffX=t,h.diffY=i,this},_moveBy:function(t){0==t.time&&(t.toX=this.x+t.diffX,t.toY=this.y+t.diffY),this.x=t.toX-t.diffX*(1-t.time/t.frame),this.y=t.toY-t.diffY*(1-t.time/t.frame)},delay:function(t){var i=l(this,"delay",t);return this.mover.push(i),this},and:function(){var t=this.mover,i=t[t.length-1];return i&&(i.and=!0),this},stop:function(){return this.mover=[],this.moverIndex=0,this},loop:function(){var t=this.mover[this.mover.length-1];return t.loop=!0,this},rotateBy:function(t,i){var e=l(this,"rotateBy",i);return e.diffAngle=t,this},_rotateBy:function(t){0==t.time&&(t.toAngle=this.rot+t.diffAngle),this.rot=t.toAngle-t.diffAngle*(1-t.time/t.frame)},then:function(t,i){var e=l(this,"then",i);return e.exec=t,this},_then:function(t){t.exec.call(this)},scaleBy:function(t,i,e){var h=l(this,"scaleBy",e);return h.scaleX=t,h.scaleY=i,this},setPosition:function(t,i){return this.x=t,this.y=i,this},saveData:function(t){var i=new Object;for(var e in this)"function"!=typeof this[e]&&(i[e]=this[e]);localStorage.setItem(t,JSON.stringify(i))},getData:function(t){var i=JSON.parse(localStorage.getItem(t));for(var e in i)this[e]=i[e]},getTouchPosition:function(t,i){i&&t.touches[i]||(i=0);var e=this.field,h=parseInt(e.width)/parseInt(e.style.width),n=parseInt(e.height)/parseInt(e.style.height),r=new Object,a=e.getBoundingClientRect(),o=parseInt(a.left),c=parseInt(a.top);isNaN(o)&&(o=0),isNaN(c)&&(c=0);var l=document.documentElement.scrollLeft||document.body.scrollLeft,u=document.documentElement.scrollTop||document.body.scrollTop;return t?!s||s&&t.touches[i]?(r.x=(s?t.touches[i].pageX:t.pageX)-o-l,r.y=(s?t.touches[i].pageY:t.pageY)-c-u):(r.x=-1,r.y=-1):(r.x=event.x-o,r.y=event.y-c),r.x=parseInt(r.x*h),r.y=parseInt(r.y*n),r},getMultiTouchPosition:function(t){for(var i=t.touches.length,e=[],h=0;i>h;h++)e[h]=this.getTouchPosition(t,h);return e},handleEvent:function(t){if(this.eventEnable){t.preventDefault();var i=this.getTouchPosition(t);i.touchCount=t.touches?t.touches.length:1,i.event=t;var e=t.type;if("keydown"==e||"keyup"==e){var h=new Object;for(var s in o)h[s]=o[s];r(h,o,t)}switch(e){case"touchstart":this.multiTouchStart&&t.touches.length>1?this.multiTouchStart(this.getMultiTouchPosition(t)):this.touchStart&&this.touchStart(i);break;case"mousedown":this.touchStart&&this.touchStart(i);break;case"touchmove":this.multiTouchMove&&t.touches.length>1?this.multiTouchMove(this.getMultiTouchPosition(t)):this.touchMove&&this.touchMove(i);break;case"mousemove":this.touchMove&&this.touchMove(i);break;case"touchend":this.multiTouchEnd&&t.touches.length>1?this.multiTouchEnd(this.getMultiTouchPosition(t)):this.touchEnd&&this.touchEnd(i);break;case"mouseup":this.touchEnd&&this.touchEnd();break;case"keydown":this.keyDown&&this.keyDown(o);break;case"keyup":this.keyUp&&this.keyUp(h)}}},useEvent:function(){var t=this.field,i=this.eventListener;this.touchStart&&0==i.touchStart&&(s?t.addEventListener("touchstart",this,!1):t.addEventListener("mousedown",this,!1),i.touchStart=!0),this.touchMove&&0==i.touchMove&&(s?t.addEventListener("touchmove",this,!1):t.addEventListener("mousemove",this,!1),i.touchMove=!0),this.touchEnd&&0==i.touchEnd&&(s?t.addEventListener("touchend",this,!1):t.addEventListener("mouseup",this,!1),i.touchEnd=!0),this.multiTouchStart&&0==i.multiTouchStart&&(i.touchStart||(s?t.addEventListener("touchstart",this,!1):t.addEventListener("mousedown",this,!1)),i.touchStart=!0),this.multiTouchMove&&0==i.multiTouchMove&&(i.touchMove||(s?t.addEventListener("touchmove",this,!1):t.addEventListener("mousemove",this,!1)),i.touchMove=!0),this.multiTouchEnd&&0==i.multiTouchEnd&&(i.touchEnd||(s?t.addEventListener("touchend",this,!1):t.addEventListener("mouseup",this,!1)),i.touchEnd=!0),this.keyUp&&0==i.keyUp&&(t.addEventListener("keyup",this,!1),i.keyUp=!0),this.keyDown&&0==i.keyDown&&(t.addEventListener("keydown",this,!1),i.keyDown=!0)},remove:function(){this._remove=!0},leave:function(){this._leave=!0},getRand:function(t,i){return~~(Math.random()*(i-t+1))+t},HSBtoRGB:function(t,i,e){var h,s,n,r,a,o,c,l;switch(s=Math.floor(t/60)%6,h=t/60-Math.floor(t/60),n=Math.round(e*(1-i/255)),r=Math.round(e*(1-i/255*h)),a=Math.round(e*(1-i/255*(1-h))),s){case 0:o=e,c=a,l=n;break;case 1:o=r,c=e,l=n;break;case 2:o=n,c=e,l=a;break;case 3:o=n,c=r,l=e;break;case 4:o=a,c=n,l=e;break;case 5:o=e,c=n,l=r}return o=15>=o?"0"+o.toString(16):o.toString(16),c=15>=c?"0"+c.toString(16):c.toString(16),l=15>=l?"0"+l.toString(16):l.toString(16),"#"+o+c+l},getSound:function(t){for(var e=0,h=i.length;h>e;e++)t==i[e].name&&(this.sound=new Audio(i[e].src))},soundClonePlay:function(){var t=this.sound;t&&new Audio(t.src).play()},soundLoopPlay:function(){var t=this.sound;t&&(t.loop||t.addEventListener("ended",function(){this.currentTime=0,this.play()},!1),t.loop=!0,t.play())},soundReplay:function(){var t=this.sound;t&&(t.load(),t.play())},soundStop:function(){var t=this.sound;t.paused?t.load():(t.pause(),t.currentTime=0)},soundPlay:function(){var t=this.sound;t&&t.play()},soundPause:function(){var t=this.sound;t&&t.pause()},soundGetCount:function(){var t=this.sound;return t?t.currentTime:void 0},soundSetCount:function(t){var i=this.sound;i&&(i.currentTime=t)},soundGetVolume:function(){var t=this.sound;return t?t.volume:void 0},soundSetVolume:function(t){var i=this.sound;i&&(i.volume=t)},soundGetAlltime:function(){var t=this.sound;return t?t.duration:void 0},soundIsPlaying:function(){var t=this.sound;return t?!t.paused:void 0}}),c.App=c.createClass(c.Util,{initialize:function(t){this.inherit(),this._basicConstructor="App";var i=document.createElement("style");i.media="screen",i.type="text/css",document.getElementsByTagName("head")[0].appendChild(i);var e;if(t)e=document.getElementById(t);else{e=document.createElement("canvas");var h=document.getElementsByTagName("body").item(0);h.appendChild(e)}e.width=320,e.height=480,e.style.top="0px",e.style.left="0px",e.tabIndex="1",document.body.style.margin="0em";navigator.userAgent;s?(e.style.width=window.innerWidth+"px",e.style.height=window.innerHeight+"px",e.addEventListener("touchstart",function(){this.focus()})):(e.style.width="480px",e.style.height="620px",e.addEventListener("mousedown",function(){this.focus()}),e.addEventListener("keyup",function(){a(o)},!1)),this._css=i,this.field=e,this.ctx=e.getContext("2d"),this.fps=30,this.scene=new Scene,this.scene.ctx=this.ctx,this.scene.field=this.field,this.scene.parent=this},getCanvasURL:function(){return this.field.toDataURL()},getCanvasImage:function(){var t=this.field.toDataURL();window.open(t,"_blank")},colorToAlpha:function(i,e){for(var h,s=0,n=t.length;n>s;s++)t[s].name==i&&(h=t[s],h.hex=e,h.index=s);h.addEventListener("load",function(){var i=document.createElement("canvas"),e=i.getContext("2d"),h=this.width,s=this.height,n=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,r=this.hex.replace(n,function(t,i,e,h){return i+i+e+e+h+h}),a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(r),o=a?{r:parseInt(a[1],16),g:parseInt(a[2],16),b:parseInt(a[3],16)}:null;e.drawImage(this,0,0);for(var c=e.getImageData(0,0,h,s),l=c.data,u=0;s>u;u++)for(var d=0;h>d;d++){var f=4*u*h+4*d;l[f]==o.r&&l[f+1]==o.g&&l[f+2]==o.b&&(l[f+3]=0)}e.putImageData(c,0,0);var v=new Image;v.src=i.toDataURL(),t[this.index]=v})},addChild:function(t){t.ctx=this.ctx,t.field=this.field,this.scene.addChild(t)},addChildren:function(){for(var t=0,i=arguments.length;i>t;t++)this.addChild(arguments[t])},centerize:function(){var t=this.field.style;t.marginTop=-parseInt(t.height)/2+"px",t.marginLeft=-parseInt(t.width)/2+"px",t.top="50%",t.left="50%",t.position="absolute"},fitWindow:function(){this.setSize(window.innerWidth,window.innerHeight);var t=this;window.onresize=function(){t.setSize(window.innerWidth,window.innerHeight)}},setQuality:function(t,i){var e=this.field;e.width=t,e.height=i},setSize:function(t,i){var e=this.field.style;e.width=t+"px",e.height=i+"px"},getSize:function(){var t=new Object;return t.width=parseInt(this.field.style.width),t.height=parseInt(this.field.style.height),t},getQuality:function(){var t=new Object;return t.width=parseInt(this.field.width),t.height=parseInt(this.field.height),t},loadingScene:function(t){this.preScene=t,this.preScene.parent=this},_preLoadEnterFrame:function(){var t=this.field;this.useEvent();var i=this.ctx;if(i.clearRect(0,0,t.width,t.height),h>0)this.preScene&&this.preScene._enterFrame();else{this.onLoad&&this.onLoad();for(var e=this.scene.children,s=0,n=e.length;n>s;s++){var r=e[s];r._onLoad&&r._onLoad(),r.onLoad&&r.onLoad()}clearInterval(this.preLoadInterval);var a=this;setInterval(function(){a._enterFrame()},1e3/this.fps)}},_enterFrame:function(){var t=this.field;this.ctx.clearRect(0,0,t.width,t.height),this.useEvent(),this.enterFrame&&this.enterFrame(),this.scene._enterFrame()},pushScene:function(t){for(var i=this.ctx,e=this.field,h=this.scene.children,s=0,n=h.length;n>s;s++){var r=h[s];r.eventEnable=!1,r.onSceneremoved&&r.onSceneRemoved()}h=t.children;for(var s=0,n=h.length;n>s;s++){var a=h[s];a.ctx=i,a.field=e,a.eventEnable=!0,a.onScenePushed&&a.onScenePushed()}t.parent=this,t.ctx=i,t.field=e;var o=this.field.style;o.background=null,o.backgroundColor="white",t.color&&this.setColor(t.color),t.image&&this.setImage(t.image),this.scene=t},setColor:function(t){var i=this.field.style;i.background=null,i.backgroundColor=t},setImage:function(t){var i=this.field.style;i.background="url("+t+") no-repeat center",i.backgroundSize="cover"},start:function(){var t=this.field,i=this;this.ctx.clearRect(0,0,t.width,t.height),this.preLoadInterval=setInterval(function(){i._preLoadEnterFrame()},1e3/this.fps)},toDataURL:function(){return this.field.toDataURL()},load:function(){function s(t){var i;if(!t)return i;var e=t.split("."),h=e.length;return 0===h?i:i=e[h-1]}for(var n=0,r=arguments.length;r>n;n++){var a=arguments[n];if(a instanceof Array)var o=a[0],c=a[1];else var o=a,c=a;var l=s(o);if("wav"==l||"mp3"==l||"ogg"==l){var a=new Audio(o);a.name=c,h++,a.addEventListener("canplaythrough",function(){h--,console.log(this.src+" is loaded")}),i.push(a)}else if("TTF"==l||"ttf"==l){var u=this._css,d=document.createTextNode("@font-face{font-family:'"+c+"';src: url('"+o+"') format('truetype');}");u.styleSheet?u.styleSheet.cssText=d:u.appendChild(d)}else if("svg"==l){var a=document.createElement("object");a.addEventListener("load",function(){h--,this.style.display="none",console.log(this.data+" is loaded")}),a.data=o,a.name=c,document.body.appendChild(a),h++,e.push(a)}else if("png"==l||"gif"==l||"jpeg"==l||"jpg"==l){var a=new Image;a.addEventListener("load",function(){h--,console.log(this.src+" is loaded")}),a.src=o,a.name=c,h++,t.push(a)}}}}),c.Thing=c.createClass(c.Util,{initialize:function(t,i){this.inherit(),this.x=0,this.y=0,this._remove=!1,this.width=t,this.height=i,this.collisionShape="box",this.alpha=1,this.field},_scaleBy:function(t){0==t.time&&(t.toWidth=this.width*t.scaleX,t.toHeight=this.height*t.scaleY,t.diffWidth=t.toWidth-this.width,t.diffHeight=t.toHeight-this.height),this.width=t.toWidth-t.diffWidth*(1-t.time/t.frame),this.height=t.toHeight-t.diffHeight*(1-t.time/t.frame)},intersect:function(t,i){var e=this._x||this.x,h=this._y||this.y,s=this._width||this.width,n=this._height||this.height,r=this._rot||this.rot;if("box"==this.collisionShape){var a=t-(e+s/2),o=i-(h+n/2),c=Math.sin(-r),l=Math.cos(-r),u=Math.abs(a*l-o*c),d=Math.abs(a*c+o*l);return s/2>u&&n/2>d?!0:!1}if("circle"==this.collisionShape){var f=s/2,a=t-(e+f),o=i-(h+f);return Math.sqrt(a*a+o*o)<f?!0:!1}return!1},hitTest:function(t){var i=this._x||this.x,e=this._y||this.y,h=this._width||this.width,s=this._height||this.height,n=i+h/2,r=e+s/2,a=t._x||t.x,o=t._y||t.y,c=t._width||t.width,l=t._height||t.height,u=t._rot||t.rot;if("box"!=this.collisionShape)return"circle"==this.collisionShape?this.within(t,h/2):!1;if("circle"==t.collisionShape)return t.within(this,c/2);if(0!=u&&u!=Math.PI&&"box"==t.collisionShape){var d=a+c/2,f=o+l/2,n=i+h/2,r=e+s/2,v=-u;n=Math.cos(v)*(n-d)-Math.sin(v)*(r-f)+d,r=Math.sin(v)*(n-d)+Math.cos(v)*(r-f)+f,i=n-h/2,e=r-s/2}return a+c>i&&i+h>a&&o+l>e&&e+s>o},within:function(t,i){var e=this._x||this.x,h=this._y||this.y,s=this._width||this.width,n=this._height||this.height,r=(this._rot||this.rot,t._x||t.x),a=t._y||t.y,o=t._width||t.width,c=t._height||t.height,l=t._rot||t.rot;if("box"==this.collisionShape)var u=e+s/2,d=h+n/2;else{if("circle"!=this.collisionShape)return!1;var f=s/2,u=e+f,d=h+f}if("box"==t.collisionShape){var v,p,g=r+o/2,m=a+c/2,y=-l,x=Math.cos(y)*(u-g)-Math.sin(y)*(d-m)+g,w=Math.sin(y)*(u-g)+Math.cos(y)*(d-m)+m;v=r>x?r:x>r+o?r+o:x,p=a>w?a:w>a+c?a+c:w;var _=Math.abs(x-v),b=Math.abs(w-p)}else{if("circle"!=t.collisionShape)return!1;var C=o/2,v=r+C,p=a+C,_=Math.abs(u-v),b=Math.abs(d-p);i+=C}return Math.sqrt(_*_+b*b)<i?!0:!1},scale:function(t,i){return this.width?(this.width*=t,this.height*=i):(this._scaleX=t,this._scaleY=i),this},setSize:function(t,i){this.width=t,this.height=i}}),c.Shape=c.createClass(c.Thing,{initialize:function(t,i,e){this.inherit(0,0),this.obj=-1,"object"==typeof t?this.path=t:"string"==typeof t&&this.setImage(t),this.closeMode=!0,this.color=i?i:"original",this.strokeColor=e?e:"original"},setImage:function(t){for(var i=0,h=e.length;h>i;i++)t==e[i].name&&(this.obj=i)},parsePath:function(t){var i={a:7,c:6,h:1,l:2,m:2,q:4,s:4,t:2,v:1,z:0},e=/([astvzqmhlc])([^astvzqmhlc]*)/gi,h=[];return t.replace(e,function(t,e,s){var n=e.toLowerCase();for(s=s.match(/-?[.0-9]+(?:e[-+]?\d+)?/gi),s=s?s.map(Number):[],"m"==n&&s.length>2&&(h.push([e].concat(s.splice(0,2))),n="l",e="m"==e?"l":"L");;){if(s.length==i[n]){if(s.unshift(e),"q"==s[0])var r={method:"quadraticCurveBy",cpx:s[1],cpy:s[2],x:s[3],y:s[4]};else if("Q"==s[0])var r={method:"quadraticCurveTo",cpx:s[1],cpy:s[2],x:s[3],y:s[4]};else if("l"==s[0])var r={method:"lineBy",x:s[1],y:s[2]};else if("L"==s[0])var r={method:"lineTo",x:s[1],y:s[2]};else if("m"==s[0])var r={method:"moveBy",x:s[1],y:s[2]};else if("M"==s[0])var r={method:"moveTo",x:s[1],y:s[2]};else if("c"==s[0])var r={method:"bezierCurveBy",cpx1:s[1],cpy1:s[2],cpx2:s[3],cpy2:s[4],x:s[5],y:s[6]};else if("C"==s[0])var r={method:"bezierCurveTo",cpx1:s[1],cpy1:s[2],cpx2:s[3],cpy2:s[4],x:s[5],y:s[6]};else if("h"==s[0])var r={method:"horizontalBy",x:s[1]};else if("H"==s[0])var r={method:"horizontalTo",x:s[1]};else if("v"==s[0])var r={method:"verticalBy",y:s[1]};else if("V"==s[0])var r={method:"verticalTo",y:s[1]};else if("s"==s[0])var r={method:"bezierCurveShortBy",cpx2:s[1],cpy2:s[2],x:s[3],y:s[4]};else if("S"==s[0])var r={method:"bezierCurveShortTo",cpx2:s[1],cpy2:s[2],x:s[3],y:s[4]};else if("t"==s[0])var r={method:"quadraticCurveShortBy",x:s[1],y:s[2]};else if("T"==s[0])var r={method:"quadraticCurveShortTo",x:s[1],y:s[2]};else var r={};return h.push(r)}h.push([e].concat(s.splice(0,i[n])))}}),h},_onLoad:function(){var t=e[this.obj].getSVGDocument(),i=t.getElementsByTagName("path")[0],h=t.getElementsByTagName("svg")[0],s=i.getAttribute("d");"original"==this.color&&(this.color=i.getAttribute("fill")),"original"==this.strokeColor&&this.strokeColor==i.getAttribute("stroke"),this.path=this.parsePath(s),this.spriteWidth=parseInt(h.getAttribute("width")),this.spriteHeight=parseInt(h.getAttribute("height")),this.width||(this.width=this.spriteWidth),this.height||(this.height=this.spriteHeight)},draw:function(){this.path||this._onLoad();var t=this.path,i=this.ctx,e=0,h=0,s=0,n=0,r=0,a=0,o=this.width,c=this.height,l=o/this.spriteWidth,u=c/this.spriteHeight,d=o/2,f=c/2,v=this._x||this.x,p=this._y||this.y,g=this._rot||this.rot;i.globalAlpha=this.alpha,i.globalCompositeOperation=this.drawMode,i.save(),i.translate(v+d,p+f),i.rotate(g),i.translate(-d,-f),i.scale(l,u),i.beginPath();for(var m=0,y=t.length;y>m;m++){var x=this.path[m],w=x.method;"moveTo"==w||"quadraticCurveTo"==w||"bezierCurveTo"==w||"lineTo"==w||"bezierCurveShortTo"==w||"quadraticCurveShortTo"==w?(s=0,n=0,e=x.x,h=x.y):(s=e,n=h,e+=x.x,h+=x.y),"moveTo"==w||"moveBy"==w?i.moveTo(e,h):"lineTo"==w||"lineBy"==w?i.lineTo(e,h):"quadraticCurveBy"==w||"quadraticCurveTo"==w?(i.quadraticCurveTo(s+x.cpx,n+x.cpy,e,h),r=2*e-(s+x.cpx),a=2*h-(n+x.cpy)):"bezierCurveTo"==w||"bezierCurveBy"==w?(i.bezierCurveTo(s+x.cpx1,n+x.cpy1,s+x.cpx2,n+x.cpy2,e,h),r=2*e-(s+x.cpx2),a=2*h-(n+x.cpy2)):"horizontalTo"==w||"horizontalBy"==w?i.lineTo(x.x,h):"verticalTo"==w||"verticalBy"==w?i.lineTo(e,x.y):"bezierCurveShortBy"==w||"bezierCurveShortTo"==w?(i.bezierCurveTo(r,a,s+x.cpx2,n+x.cpy2,e,h),r=2*e-(s+x.cpx2),a=2*h-(n+x.cpy2)):("quadraticCurveShortBy"==w||"quadraticCurveShortTo"==w)&&(i.quadraticCurveTo(r,a,e,h),r=2*e-r,a=2*h-a)}this.closeMode&&i.closePath(),i.fillStyle=this.color,i.fill(),i.strokeStyle=this.strokeColor,i.stroke(),i.restore()},getNodeByName:function(t){for(var i=this.path,e=0,h=i.length;h>e;e++){var s=i[e];if(t==s.name)return s}return-1}}),c.Shape.Box=c.createClass(c.Thing,{initialize:function(t,i,e){this.inherit(i,e),this._basicConstructor="Shape",this.color=t},draw:function(){var t=this.ctx;t.globalAlpha=this.alpha,t.globalCompositeOperation=this.drawMode,t.beginPath(),t.fillStyle=this.color;var i=this._x||this.x,e=this._y||this.y,h=this._rot||this.rot,s=(this._width||this.width,this._height||this.height,i+this.width/2),n=e+this.height/2;t.save(),t.translate(s,n),t.rotate(h),t.translate(-s,-n);var i=this._x||this.x,e=this._y||this.y;t.fillRect(i,e,this.width,this.height),t.restore(),t.globalAlpha=1}}),c.Shape.Circle=c.createClass(c.Thing,{initialize:function(t,i){this.inherit(2*i,2*i),this._basicConstructor="Shape",this.color=t,this.collisionShape="circle"},draw:function(){var t=this.ctx;t.globalAlpha=this.alpha,t.globalCompositeOperation=this.drawMode,t.beginPath(),t.fillStyle=this.color;var i=this._width||this.width,e=i/2,h=this._x||this.x,s=this._y||this.y;t.arc(h+e,s+e,e,0,2*Math.PI,!1),t.fill(),t.globalAlpha=1}}),c.Sprite=c.createClass(c.Thing,{initialize:function(t,i,e){"undefined"==typeof i&&(i=null,e=null),this.inherit(i,e),this.setImage(t,i,e),this._basicConstructor="Sprite",this.frame=0,this.alpha=1},animate:function(t,i,e){var h=l(this,"animate",e);return h.array=t,h.frameRate=i,h.frameIdx=0,this},_animate:function(t){0==t.time&&(this.frame=t.array[0]),t.time%t.frameRate==0&&(t.frameIdx=(t.frameIdx+1)%t.array.length,this.frame=t.array[t.frameIdx])},setSpriteSize:function(t,i){this.spriteWidth=t,this.spriteHeight=i},setImage:function(i,e,h){e&&h&&this.setSpriteSize(e,h);for(var s=t.length,n=0;s>n;n++)t[n].name==i&&(this.img=n)},getImage:function(){return t[this.img]},getImageSize:function(){var i={},e=t[this.img];return i.width=e.width,i.height=e.height,i},draw:function(){var i=this.ctx;i.globalAlpha=this.alpha,i.globalCompositeOperation=this.drawMode;var e=this.frame,h=t[this.img],s=this.spriteWidth,n=this.spriteHeight,r=this._width||this.width,a=this._height||this.height,o=r/2,c=a/2,l=h.width/s,u=h.height/n,d=r/s,f=a/n,v=e%l*s,p=~~(e/l)%u*n,g=this._x||this.x,m=this._y||this.y,y=this._rot||this.rot;i.save(),i.translate(g+o,m+c),i.rotate(y),i.translate(-o,-c),i.scale(d,f),null!=v&&i.drawImage(h,v,p,s,n,0,0,s,n),i.restore(),i.globalAlpha=1}}),c.Map=c.createClass(c.Sprite,{initialize:function(t,i,e){this.inherit(t,i,e),this.drawData,this.hitData},intersect:function(t,i){for(var e=this.hitData,h=e[0].length,s=e.length,n=this._width||this.width,r=this._height||this.height,a=this._x||this.x,o=this._y||this.y,c=0;s>c;c++)for(var l=0;h>l;l++)if(1==e[c][l]&&t>a+l*n&&a+(l+1)*n>t&&i>o+c*r&&o+(c+1)*r>i)return!0;return!1},draw:function(){var i=this.drawData,e=i[0].length,h=i.length,s=this._width||this.width,n=this._height||this.height,r=this._x||this.x,a=this._y||this.y,o=0,c=0,l=this.field,u=this.ctx;u.globalAlpha=this.alpha,u.globalCompositeOperation=this.drawMode;for(var d,f=l.height,v=l.width,p=t[this.img],g=this.spriteWidth,m=this.spriteHeight,y=p.width/g,x=p.height/m,w=this.width/g,_=this.height/m,b=r,C=a;h>o;){for(;e>c;){if(d=i[o][c],d>=0&&f>a+n*o&&a+n*(o+1)>0&&v>r+s*c&&r+s*(c+1)>0){var M=d%y*g,S=~~(d/y)%x*m;u.save(),u.translate(b,C),u.scale(w,_),u.drawImage(p,M,S,g,m,0,0,g,m),u.restore()}b+=s,c++}C+=n,b=r,o++,c=0}}}),c.Text=c.createClass(c.Util,{initialize:function(t,i,e,h){this.inherit(),this._basicConstructor="Text",this.x=0,this.y=0,this.scaleX=1,this.scaleY=1,this.alpha=1,this.spaceWidth=7,this.font=h?"'"+h+"'":"'Meiryo'",this.size=e?e+"px":"10px",this.string=t?t:"",this.color=i?i:"white"},setSize:function(t){this.size=t+"px"},setFont:function(t){this.font="'"+t+"'"},intersect:function(t,i){var e=this._x||this.x,h=this._y||this.y,s=parseInt(this.size)*this.scaleX*this.string.length,n=parseInt(this.size)*this.scaleY,r=t-(e+s/2),a=i-(h+n/2),o=this._rot||this.rot,c=Math.sin(-o),l=Math.cos(-o),u=Math.abs(r*l-a*c),d=Math.abs(r*c+a*l);return s/2>u&&n/2>d?!0:!1},scale:function(t,i){this.scaleX*=t,this.scaleY*=i},_scaleBy:function(t){0==t.time&&(t.diffWidth=t.scaleX-this.scaleX,t.diffHeight=t.scaleY-this.scaleY),this.scaleX=t.scaleX-t.diffWidth*(1-t.time/t.frame),this.scaleY=t.scaleY-t.diffHeight*(1-t.time/t.frame)},draw:function(){var t=this._x||this.x,i=this._y||this.y,e=this._rot||this.rot,h=this.scaleX,s=this.scaleY,n=this.ctx,r=this.string.split("<br>"),a=r.length;n.globalAlpha=this.alpha,n.globalCompositeOperation=this.drawMode,n.font=this.size+" "+this.font;var o=1.5*n.measureText("a").width+this.spaceWidth;n.fillStyle=this.color,n.save();var c=parseInt(this.size)*this.scaleX*this.string.length/2,l=parseInt(this.size)*this.scaleY/2;n.translate(t+c,i+l),n.rotate(e),n.translate(-c,-l),n.scale(h,s);for(var u=0;a>u;u++)n.fillText(r[u],0,o),o*=2;n.restore(),n.globalAlpha=1}}),c.Group=c.createClass(c.Thing,{initialize:function(){this.children=[],this.inherit(),this.x=0,this.y=0,this._basicConstructor="Group"},draw:function(){for(var t=this.children,i=0,e=t.length;e>i;i++){var h=t[i];h._x=h.x+this.x,h._y=this.y+this.y}},addChild:function(t){t.parent=this,this.children.push(t)},addChildren:function(){for(var t=0,i=arguments.length;i>t;t++)this.addChild(arguments[t])},getChild:function(t){var i=this.getChildren(t),e=i[0];return e||(e=null),e},getChildren:function(t){for(var i=[],e=this.children,h=0,s=e.length;s>h;h++){var n=!0;for(var r in t)if("$not"==r)for(var a in t.$not)t.$not[a]==e[h][a]&&(n=!1);else t[r]!=e[h][r]&&(n=!1);1==n&&i.push(e[h])}return i},removeChild:function(t){var i=this.getChild(t);i.remove()},removeChildren:function(t){for(var i=this.getChildren(t),e=0,h=i.length;h>e;e++)i[e].remove()}}),c.Scene=c.createClass(c.Group,{initialize:function(){this.inherit(),this._basicConstructor="Scene",this._remove=!1},addChild:function(t){if(t.parent=this,this.ctx&&this.field&&(t.ctx=this.ctx,t.field=this.field),this.children.push(t),"Group"==t._basicConstructor||"Layer"==t._basicConstructor)for(var i=t.children,e=0,h=i.length;h>e;e++){var s=i[e];s.ctx||(s.ctx=this.ctx,s.field=this.field,this.children.push(s))}},setImage:function(t){this.image=t},setColor:function(t){this.color=t},_enterFrame:function(){this.enterFrame&&this.enterFrame();for(var t=this.children,i=0,e=t.length;e>i;i++){var h=t[i];if(h._remove)t.splice(i,1),h=null,i--,e--;else{if("Sprite"==h._basicConstructor&&!h.spriteWidth){var s=h.getImageSize();s.width&&(h.setSpriteSize(s.width,s.height),h.width||(h.setSize(s.width,s.height),h._scaleX&&h.scale(h._scaleX,h._scaleY)))}h.useEvent&&h.useEvent(),h._enterFrame&&h._enterFrame(),h.enterFrame&&h.enterFrame(),h.tween&&h.tween(),h.visible&&(h.preDraw&&h.preDraw(),h.draw())}}}}),c.Layer=c.createClass(c.Group,{initialize:function(){this.inherit(),this.rot=0,this._basicConstructor="Layer",this.firstWidth=100,this.firstHeight=100,this.height=100,this.width=100,this.scaleX=1,this.scaleY=1},fitToChildren:function(){var t=this.children,i=this.x,e=this.y;this.x=null,this.y=null,this.width=0,this.height=0;for(var h=0,s=t.length;s>h;h++){var n=t[h],r=n._x||n.x,a=n._y||n.y,o=n._width||n.width,c=n._height||n.height,l=r+o/2,u=a+c/2,d=n._rot||n.rot;if(d%=2*Math.PI,0>d&&(d+=2*Math.PI),d>=0&&d<=Math.PI/2)var f=Math.cos(d)*(r-l)-Math.sin(d)*(a+c-u)+l,v=Math.cos(d)*(r+o-l)-Math.sin(d)*(a-u)+l,p=Math.sin(d)*(r-l)+Math.cos(d)*(a-u)+u,g=Math.sin(d)*(r+o-l)+Math.cos(d)*(a+c-u)+u;else if(Math.PI/2<d&&d<=Math.PI)var f=Math.cos(d)*(r+o-l)-Math.sin(d)*(a+c-u)+l,v=Math.cos(d)*(r-l)-Math.sin(d)*(a-u)+l,p=Math.sin(d)*(r-l)+Math.cos(d)*(a+c-u)+u,g=Math.sin(d)*(r+o-l)+Math.cos(d)*(a-u)+u;else if(Math.PI<d&&d<=1.5*Math.PI)var f=Math.cos(d)*(r+o-l)-Math.sin(d)*(a-u)+l,v=Math.cos(d)*(r-l)-Math.sin(d)*(a+c-u)+l,p=Math.sin(d)*(r+o-l)+Math.cos(d)*(a+c-u)+u,g=Math.sin(d)*(r-l)+Math.cos(d)*(a-u)+u;else if(1.5*Math.PI<d&&d<=2*Math.PI)var f=Math.cos(d)*(r-l)-Math.sin(d)*(a-u)+l,v=Math.cos(d)*(r+o-l)-Math.sin(d)*(a+c-u)+l,p=Math.sin(d)*(r+o-l)+Math.cos(d)*(a-u)+u,g=Math.sin(d)*(r-l)+Math.cos(d)*(a+c-u)+u;(!this.x||this.x>f)&&(this.x=f),(!this.y||this.y>p)&&(this.y=p),this.width<v&&(this.width=v),this.height<g&&(this.height=g)}this.width-=this.x,this.height-=this.y,this.firstWidth=this.width,this.firstHeight=this.height;for(var h=0,s=t.length;s>h;h++){var n=t[h];n._x?(n.x+=i-this.x,n.y+=e-this.y):(n._x=n.x,n._y=n.y,n.x-=this.x,n.y-=this.y)}return this},release:function(t){var i=this.parent;t.x=t._x,t.y=t._y,t.width=t._width,t.height=t._height,t.rot=t._rot,t._x=null,t._y=null,t._width=null,t._height=null,t._rot=null,t.grouped=!1,t._leave=!1,t.parent=i},remove:function(){for(var t=this.children,i=0,e=t.length;e>i;i++){var h=t[i];this.release(h)}return this.children=[],this._remove=!0,this},_setAbsPos:function(t){var i=this.width/2,e=this.height/2,h=this.rot;t.Cx=this.scaleX*t.x+t._width/2,t.Cy=this.scaleY*t.y+t._height/2,t.startRot=!0;var s=Math.cos(h)*(t.Cx-i)-Math.sin(h)*(t.Cy-e)+i,n=Math.sin(h)*(t.Cx-i)+Math.cos(h)*(t.Cy-e)+e;t._x=s-t._width/2,t._y=n-t._height/2,t._x+=this.x,t._y+=this.y},draw:function(){var t=this.children;this.scaleX=this.width/this.firstWidth,this.scaleY=this.height/this.firstHeight;for(var i=0,e=t.length;e>i;i++){var h=t[i];h._leave?(t.splice(i,1),this.release(h),i--,e--):(h._rot=h.rot+this.rot,h._width=this.scaleX*h.width,h._height=this.scaleY*h.height,this._setAbsPos(h))}}}),window.Atlas=c}();